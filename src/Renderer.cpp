#include "stdafx.hpp"
#include "Renderer.hpp"
// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:



// 										ta muito pedreiro. REFAZER RENDERIZADOR DO ZERO, USANDO NANOGUI!!!!!!!!



// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:
// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:// TODO:



enum test_enum {
    Item1 = 0,
    Item2,
    Item3
};

bool bvar = true;
int ivar = 12345678;
double dvar = 3.1415926;
float fvar = (float)dvar;
std::string strval = "A string";
test_enum enumval = Item2;
nanogui::Color colval(0.5f, 0.5f, 0.7f, 1.f);

_2DSurface *surf;
triple_t color = triple_t(0,0,0);
bool nodes;
class myMan : public nanogui::Screen{
public:
	myMan() : nanogui::Screen(){

	}
	virtual void drawContents(){
		static std::vector<triple_t> randomColors;
		if (randomColors.empty())
		{
			Util::randColors(randomColors, (int)surf->parts.size());
		}

		// Rasterise edges as lines
		glBegin(GL_LINES);
		int count = 0;
		for (size_t i = 0; i < surf->parts.size(); i++)
		{
			for (auto e = surf->parts[i].begin(); e != surf->parts[i].end(); e++)
			{
				glColor3f(randomColors[i]._1, randomColors[i]._2, randomColors[i]._3);
				glVertex2f((*surf->coords)[surf->graph->source(*e)].x, (*surf->coords)[surf->graph->source(*e)].y);

				glColor3f(randomColors[i]._1, randomColors[i]._2, randomColors[i]._3);
				glVertex2f((*surf->coords)[surf->graph->target(*e)].x, (*surf->coords)[surf->graph->target(*e)].y);
			}
		}
		glEnd();

		// Rasterise nodes as squares if nodes is true
		if (nodes)
		{
			for (ListDigraph::NodeIt no(*surf->graph); no != INVALID; ++no)
			{
				glBegin(GL_TRIANGLE_STRIP); // Performance bonus when compared to Quads (2 triangles = 6 vertices)

				glColor3f(color._1, color._2, color._3);
				glVertex2f((*surf->coords)[no].x - 0.007f, (*surf->coords)[no].y + 0.007f);

				glColor3f(color._1, color._2, color._3);
				glVertex2f((*surf->coords)[no].x - 0.007f, (*surf->coords)[no].y - 0.007f);

				glColor3f(color._1, color._2, color._3);
				glVertex2f((*surf->coords)[no].x + 0.007f, (*surf->coords)[no].y + 0.007f);

				glColor3f(color._1, color._2, color._3);
				glVertex2f((*surf->coords)[no].x + 0.007f, (*surf->coords)[no].y - 0.007f);

				glEnd();
			}
		}
	}
};

myMan *screen = nullptr;

nanogui::FormHelper *gui;

Renderer::Renderer()
{
}

Renderer::~Renderer()
{
}

int Renderer::initWindow()
{
	if (!glfwInit())
	{
		return -1;
	}
	
	glfwSetTime(0);

	/* Nanovg explicitly requires GLFW version 3. See nanogui example3.cpp for more details */
	glfwWindowHint(GLFW_CONTEXT_VERSION_MAJOR, 3);
    glfwWindowHint(GLFW_CONTEXT_VERSION_MINOR, 3);
    glfwWindowHint(GLFW_OPENGL_PROFILE, GLFW_OPENGL_CORE_PROFILE);
    glfwWindowHint(GLFW_OPENGL_FORWARD_COMPAT, GL_TRUE);

	window = glfwCreateWindow(wWidth, wHeight, "Surface2D", NULL, NULL);

	if (!window) {
        std::cout << "Failed to create GLFW window" << std::endl;
        glfwTerminate();
        return -1;
    }

	// Glew initialization skipped (I think glfw takes care of that)

	glfwMakeContextCurrent(window);

#if defined(NANOGUI_GLAD)
    if (!gladLoadGLLoader((GLADloadproc) glfwGetProcAddress))
        throw std::runtime_error("Could not initialize GLAD!");
    glGetError(); // pull and ignore unhandled errors like GL_INVALID_ENUM
#endif
/********************* NANOGUI CODE *********************/
	// Create a nanogui screen and pass the glfw pointer to initialize
    screen = new myMan();
    screen->initialize(window, true);

    // Create nanogui gui
    bool enabled = true;
    gui = new nanogui::FormHelper(screen);
    nanogui::ref<nanogui::Window> nanoguiWindow = gui->addWindow(Eigen::Vector2i(10, 10), "Form helper example");
    gui->addGroup("Basic types");
    gui->addVariable("bool", bvar)->setTooltip("Test tooltip.");
    gui->addVariable("string", strval);

    gui->addGroup("Validating fields");
    gui->addVariable("int", ivar)->setSpinnable(true);
    gui->addVariable("float", fvar)->setTooltip("Test.");
    gui->addVariable("double", dvar)->setSpinnable(true);

    gui->addGroup("Complex types");
    gui->addVariable("Enumeration", enumval, enabled)->setItems({ "Item 1", "Item 2", "Item 3" });
    gui->addVariable("Color", colval)
       ->setFinalCallback([](const nanogui::Color &c) {
             std::cout << "ColorPicker Final Callback: ["
                       << c.r() << ", "
                       << c.g() << ", "
                       << c.b() << ", "
                       << c.w() << "]" << std::endl;
         });

    gui->addGroup("Other widgets");
    gui->addButton("A button", []() { std::cout << "Button pressed." << std::endl; })->setTooltip("Testing a much longer tooltip, that will wrap around to new lines multiple times.");;

    screen->setVisible(true);
    screen->performLayout();
    nanoguiWindow->center();
/********************* NANOGUI CODE *********************/

	return 1;
}

void Renderer::preLoopGL()
{
	glClearColor(0.0f, 0.0f, 0.0f, 1.0f);
	glClear(GL_COLOR_BUFFER_BIT);
	glMatrixMode(GL_PROJECTION);
	glLoadIdentity();
	glOrtho(0.0, 0, 0, 0.0, -1.0, 1.0);
	glMatrixMode(GL_MODELVIEW);
	glLoadIdentity();
}

void Renderer::postLoopGL()
{
#ifdef __APPLE__
	static short int swap = 0;
	if (swap >= 2)
	{
		glfwSwapBuffers(this->window);
		swap = 0;
	}
	swap++;

	static short int macMoved = 0;

	if (macMoved < 10)
	{

		int x, y;
		glfwGetWindowPos(this->window, &x, &y);
		glfwSetWindowPos(this->window, ++x, y);
		macMoved++;
	}
#else
	glfwSwapBuffers(this->window);
#endif
	glfwPollEvents();
}

void Renderer::handle(int code)
{
	switch (code)
	{
	case -1:
		glfwTerminate();
		exit(EXIT_FAILURE);
	default:
		return;
	}
}

void Renderer::render_axes()
{
	glBegin(GL_LINES);

	glColor3f(0.5f, 0.5f, .5f);
	glVertex2f(0, 1);

	glColor3f(0.5f, 0.5f, .5f);
	glVertex2f(0, -1);

	glColor3f(0.5f, 0.5f, .5f);
	glVertex2f(1, 0);

	glColor3f(0.5f, 0.5f, .5f);
	glVertex2f(-1, 0);
	glEnd();

	for (double marker = -1.0; marker < 1.0; marker += 0.1)
	{
		char stringForm[10];
		//	sprintf(stringForm, "%.1f", marker);
		// Small lines are drawn at the marker's position
		glBegin(GL_LINES);

		// X-axis:
		glColor3f(0.5f, 0.5f, .5f);
		glVertex2f(marker, -0.009);

		glColor3f(0.5f, 0.5f, .5f);
		glVertex2f(marker, 0);

		// Y-axis:
		if (marker <= 0.01 && marker >= -0.01) // We can skip the Y axis if it's the origin
		{
			glEnd(); // But before we do that, we have to glEnd()
					 //	glEnable(GL_BLEND);
					 //	render_text(font, stringForm, point_t(marker, -0.02), 13); // and render our current text iteration ofc
			continue;
		}
		glColor3f(0.5f, 0.5f, .5f);
		glVertex2f(-0.009, marker);

		glColor3f(0.5f, 0.5f, .5f);
		glVertex2f(0, marker);
		glEnd();

		glEnable(GL_BLEND);
		//	render_text(font, stringForm, point_t(marker, -0.02), 13);
		//	render_text(font, stringForm, point_t(0.0, marker - 0.003), 13);
	}
}

void Renderer::render_surface(_2DSurface &surface, const triple_t colorOfSurface, bool shouldNodesBeRendered)
{
	surf = &surface;
	color = colorOfSurface;
	nodes = shouldNodesBeRendered;
	screen->drawWidgets();
	screen->drawContents();
}